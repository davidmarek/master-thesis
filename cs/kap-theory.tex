% !TEX root = prace.tex
\chapter{Teorie dialogových systémů}

\section{Dialogový systém}

Dialogový systém je počítačový systém, který umožňuje uživatelům komunikovat s počítačem ve formě, která je přirozená a efektivní pro použití.
Dialogové systémy stále mají spoustu problémů k překonání a pro praktické použití je třeba se uchýlit k několika předpokladům a zjednodušením.
Prvním zjednodušením je doménová specializace, v současné době není možné vytvořit dialogový systém, který by se dokázal s uživatelem bavit o libovolném tématu.
Vždy je potřeba při vývoji dialogového systému mít ontologii určující, jaké informace má systém poskytovat a o čem se může chtít uživatel bavit.

Další zjednodušení se týkají přímo dialogu.
Předpokládá se, že dialog probíhá vždy mezi systémem a jedním uživatelem.
Navíc se pravidelně střídají v obrátkách.
Jedna obrátka dialogu je složená z jedné promluvy systému a jedné promluvy uživatele.

Příkladem dialogového systému může být systém pro nalezení spojení pomocí
městské dopravy. Příkazu od uživatele může vypadat např. takto: \uv{Chci jet z
Malostranského náměstí na Anděl}. Dialogový systém se nyní může rozhodnout,
zda-li mu zadané informace stačí pro nalezení spojení. V tomto případě systém
stále neví, kdy chce uživatel jet. Může předpokládat, že uživatel už na
zastávce stojí a tak tedy uživateli nalezne nejbližší spojení.

Důležitou vlastností dialogového systému je robustnost. Pokud budeme používat
dialogový systém v přirozeném prostředí, musíme se vyrovnat s tím, že často
nebude uživateli rozumět.
Systém může informaci přeslechnout, anebo si nemusí být jistý tím, co slyšel.
Dialogový systém se proto musí umět uživatele doptat na chybějící informace


\section{Součásti dialogového systému}

Dialogový systém se skládá z několika částí, které spolu komunikují.
Na vstupu je zvukový záznam uživatele, o jeho převedení do textu se stará systém rozpoznávání řeči (ASR).
Z textu je potřeba získat sémantické informace pomocí systému porozumění mluvené řeči (SLU).
Nad sémanticky anotovanými informacemi už může pracovat dialogový manager (DM), který zvolí patřičnou odpověď.
Výstupem dialogového manageru jsou informace, které se mají předat uživateli.
O jejich převedení do textu se stará systém generování přirozené řeči (NLG).
Do zvukového záznamu převede text syntetizér řeči (TTS).

\subsection{Systém rozpoznávání řeči (ASR)}

Systém rozpoznávání řeči slouží k převedení mluveného projevu do textové podoby.
Po získání textové podoby je teprve možné se zabývat významem textu.
Aktuálně nejlepší systémy jsou založené na pravděpodobnostním modelu a využívají skryté Markovské modely (HMM) k určení nejpravděpodobnější sekvence slov pro daný zvukový záznam.
Pro tuto část dialogového systému existuje řada dostupných otevřených toolkitů, např. systém HTK \cite{young2002htk}, Kaldi \cite{Povey_ASRU2011} nebo SPHINX~\cite{walker2004sphinx}.
Existuje i celá řada komerčního software od firem jako IBM nebo Nuance.

Úspěšnost systému rozpoznání řeči je závislá na obtížnosti úlohy a na počtu trénovacích dat, pocházejících ze stejné domény.
Pro obecnou doménu se problém stává mnohem těžší a je třeba velké množství dat.
Word error rate (WER) je častá metrika pro počítání výkonu ASR.
Pro spočítání WER je třeba nejprve provést zarovnání rozpoznaného a originálního textu. WER je pak počet slov, která jsou změněná, smazaná anebo přidaná, vydělený počtem slov v originálním textu.
Systém Let's Go!~\cite{raux2006doing} dosahuje průměrné WER $64.3\%$.

Systém rozpoznávání řeči může produkovat více hypotéz pro jeden vstup.
Často existuje pro jeden zvukový záznam více možných slovních sekvencí, z kterých by mohl pocházet.
Reprezentace možných hypotéz může být seznam slovních sekvencí s jejich věrohodností.
Věrohodnosti jsou skóre přiřazené hypotézám, které určují jakou důvěru má systém rozpoznávání řeči ve správnost dané slovní sekvence.
\todo{Přidat příklad seznamu hypotéz}
V ideálním případě je věrohodnost ekvivalentní aposteriorní pravděpodobnosti sekvence slov, dáno vstupní zvuk.
Ovšem ne všechny rozpoznávače pracují na pravděpodobnostním principu a pak není možné od nich požadovat skutečné pravděpodobnosti.

Další možností jak reprezentovat výstup je použití konfůzní sítě \cite{bertoldi2005new}.
Konfůzní síť je vážený orientovaný graf, obsahující startovní a konečný vrchol a hrany označené slovy.
Každá cesta ze startovního do konečného vrcholu vede přes všechny ostatní vrcholy.
Váhy hran jsou pravděpodobnosti slova přiřazeného dané hraně.
Hrany mohou obsahovat i prázdné slovo $\epsilon$.
Pravděpodobnost sekvence slov je součinem vah po cestě ze startovního do konečného uzlu.
Výhodou konfůzní sítě je, že umožňuje v komprimované podobě uložit mnohem více hypotéz.
\todo{Přidat příklad konfůzní sítě}

\subsection{Porozumění mluvené řeči (SLU)}

Jakmile má systém seznam možných hypotéz toho, co uživatel řekl, musí se pokusit porozumět, co tím uživatel myslel.
Dialogový systém nepotřebuje vědět, co přesně uživatel řekl, důležité je pouze zjistit, co se uživatel snaží sdělit.
Pokud například uživatel řekne "Chtěl bych nalézt spojení z Malostranského náměstí na Anděl", anebo "Jak se dostanu na Anděl ze zastávky Malostranské náměstí?", tak výsledek je stejný, uživatel požaduje informace o spojení mezi dvěma zastávkami, i když v jednom případě jde o větu oznamovací a v druhém případě o otázku.

Semántická reprezentace sdělení uživatele se nazývá dialogový akt (DA), skládá se z jedné nebo více položek dialogového aktu (DAI), které jsou spojené v konjunkci.
Každá DAI se skládá z typu, názvu slotu a jeho hodnoty. Typy jsou doménově nezávislé, sloty a jejich hodnoty reprezentují koncepty ontologie.
Příklad dialogového aktu z dialogového systému pro hledání restaurací:

\begin{center}
{\tt hello()\&inform(food="chinese")}.
\end{center}

Zde se dialogový akt skládá ze dvou položek, první položka má pouze typ {\em hello}, značící pozdrav.
Druhá položka má typ {\em inform}, tzn. uživatel nás informuje o svém požadavku.
Název slotu je {\em food} a hodnota je \uv{chinese}, tedy uživatel nám říká, že hledá restauraci, kde servírují čínské jídlo.

Typů může být libovolné množství, ale existuje několik základních, jejichž použití je ustálené.
\begin{itemize}
\item {\em inform} --- sdělujeme informaci, doplňujeme hodnotu do slotu,
\item {\em request} --- požadujeme od protějšku doplnění hodnoty pro dotazovaný slot,
\item {\em confirm} --- chceme potvrdit hodnotu slotu, potvrzení může být implicitní, anebo explicitní.
	Při explicitním potvrzení očekáváme odpověď buď \uv{Ano} nebo \uv{Ne},
	U implicitního, pokud se nám nedostane odpovědi předpokládáme, že protějšek souhlasí,
\item {\em select} --- žádáme protějšek, aby zvolil z nabízených možností.
\end{itemize}

Existuje široké množství technik, které lze použít pro porozumění mluvené řeči.
Unifikace pomocí šablon anebo gramatiky jsou příklady ručně psaných metod.
Metody založené na datech jsou například Hidden Vector State model~\cite{he2005semantic}, techniky strojového překladu~\cite{wong2007learning}, Combinatory Categorical Grammars~\cite{zettlemoyer2007online} nebo Support Vector Machines~\cite{mairesse2009spoken}.

\subsection{Dialogový manager (DM)}

Pokud už jsou pravděpodobné dialogové akty dekódovány, je třeba rozhodnout, co bude systém dělat.
Komponenta tvořící tato rozhodnutí je dialogový manager.
Odpověď systému je zakódována do formy dialogových aktů a nazývá se systémová akce.

Zvolená systémová akce je vybrána z množiny možných akci $a \in \mathcal{A}$ a závisí na vstupu, který systém obdržel z SLU.
Tento vstup se nazývá pozorování $o \in \mathcal{O}$, protože obsahuje vše, co systém pozoroval o uživateli.

Zvolení správné akce potřebuje více znalostí než jen poslední pozorování.
Celá historie dialogu a také kontext hrají důležitou roli.
Dialogový manager bere na vše ohled pomocí udržovaní interní reprezentace celého pozorovaného dialogu.
Tato reprezentace se nazývá dialogový stav, nebo také belief stav, značí se $b \in \mathcal{B}$.
Aktuální dialogový stav závisí na přechodové funkci, která dialogový stav aktualizuje pro každé nové pozorování a systémovou akci.
Přechodová funkce je tedy mapování $\mathcal{T} : \mathcal{B} \times \mathcal{A} \times \mathcal{O} \longrightarrow \mathcal{B}$.
V této práci se budeme věnovat právě metodám aktualizace dialogového stavu.

Chování dialogového stavu definuje dialogová strategie $\pi$.
Strategie určuje co má systém provést v závislosti na aktuálním dialogovém stavu.
Obecně strategie vytvoří pravděpodobnostní rozložení přes možné akce.
Pokud $\prod(\mathcal{A})$ značí množinu těchto distribucí, pak dialogová strategie bude zobrazení z dialogového stavu do této množiny, $\pi: \mathcal{B} \longrightarrow \prod(\mathcal{A})$.

Pozorování, dialogový stav a akce jsou číslovány podle obrátky.
Pokud je časový okamžik důležitý, jsou pozorování, dialogový stav a akce z obrátky číslo $t$ označeny $o_t$, $b_t$ a $a_t$.

\subsection{Generování přirozené řeči (NLG a TTS)}

Posledním krokem v tahu dialogového systému je vytvoření odpovědi pro uživatele.
Nejprve systém generování přirozené řeči převede dialogové akty na text.
Následně je text převeden na zvuk pomocí textového syntetizéru řeči.

Nejjednodušším přístup ke generování přirozeného jazyka z dialogových aktů je použití šablon.
Například pro dialogový akt {\tt inform(type="x")} bude vytvořena šablona \uv{Restaurace servíruje x jídlo}, kde \uv{x} bude nahrazeno například za \uv{čínské}, \uv{indické}, atd.
Šablony se při generování osvědčily, protože počet možných dialogových je většinou zvládnutelný.

Při syntéze řeči existuje mnoho alternativ.
Je možné použít segmenty řeči z databáze pro vygenerování zvuků tvořících dohromady celou sekvenci slov.
Příkladem těchto systémů je Festival~\cite{black2001festival} nebo FLite~\cite{black2001flite}.

Alternativní metodou syntézy je použití skrytých Markovských modelů pro generování zvuku, příkladem je HTS systém~\cite{zen2007hmm}.

\section{Dialogový stav}

Nejistota je základním problémem, s kterým se dialogový systém musí vypořádat.
Systémy pro rozpoznávání i porozumění řeči často chybují a tuto možnost musí brát dialogový manager v potaz.
Vypořádat se s nejistotou lze pomocí jejího zakomponování do modelu pro odhad dialogového stavu.

Cíle uživatele a další vlastnosti prostředí lze považovat za náhodné částečně pozorovatelné proměnné a je možné je odvodit z pozorování.
Pravděpodobnostní rozložení těchto náhodných proměnných dává dobře definovanou reprezentaci nejistoty, navíc je možné je reprezentovat pomocí Bayesovské sítě.

Jedním z možných modelů dialogového stavu je generativní model.
Definujeme množinu stavů prostředí, $s \in \mathcal{S}$.
Předpokládáme, že pozorování závisí podmíněně pouze na stavu prostředí a definujeme pravděpodobnostní rozdělení pro pozorování, $p(o \mid s)$.
Dále předpokládáme, že cíle uživatele se nemění v čase a stav prostředí je tedy závislý pouze na stavu v předchozí obrátce a na poslední akci systému.
Tato závislost je zachycena v přechodové pravděpodobnosti $p(s_{t+1} \mid s_t, a_t)$.
Předpoklad, že stav prostředí závisí pouze na minulé hodnotě se nazývá Markovská vlastnost.

Pokud vezmeme předchozí předpoklady, tak lze využít bayesovský přístup pro počítání s nejistotou.
Stav v čase $t$ označíme $s_t$.
Podle Bayesova vzorce můžeme spočítat pravděpodobnost stavu v čase $t+1$ po přijetí nového pozorování $o_{t+1} = o^\prime$.

\begin{equation}
p(s_{t+1} = s^\prime) \propto
    \sum_{s \in \mathcal{S}}
        p(s_t = s)
        p(s_{t+1} = s^\prime \mid s_t = s, a_t = a) p(o_{t+1} = o^\prime \mid s_{t+1} = s^\prime)
\label{eq:beliefupdate}
\end{equation}

Nyní můžeme definovat dialogový stav v čase $t$, $b_t$, jako pravděpodobnost přes stavy dáno všechna pozorování až do času $t$.
Množina všech možných dialogových stavů je pravděpodobnost přes všechny možné stavy prostředí $\mathcal{B} = \prod(\mathcal{S})$.

Můžeme přepsat rovnici~\eqref{eq:beliefupdate} s pomocí dialogových stavů.

\begin{equation}
b(s_{t+1}) \propto
    \sum_{s \in \mathcal{S}}
        b(s_t)
        p(s_{t+1} \mid s_t, a_t)
        p(o_{t+1} \mid s_{t+1})
\label{eq:beliefupdate2}
\end{equation}

Rovnice~\eqref{eq:beliefupdate2} nám dává předpis pro přechodovou funkci $\mathcal{T}$.
V praxi ovšem bude množina možných hodnot pro slot $s_t$ příliš velká, protože stav musí obsahovat všechny informace potřebné pro rozhodování, to znamená celou historii dialogu a cíle uživatele. 
Pokud systém obsahuje sloty, tak každá kombinace hodnot slot je jedním možným cílem uživatele. 
Tedy velikost stavového prostoru roste exponenciálně.

\subsection{Aktualizace dialogového stavu}

Efektivní metodou pro aktualizaci dialogového stavu je použití dynamických bayesovských sítí~\cite{thomson2008bayesian}.
Bayesovské sítě umoňují efektivní výpočet využitím podmíněných nezávislostí mezi sloty.
Stále ovšem zůstává problém s výpočtem, pokud i jednotlivé sloty obsahují příliš mnoho hodnot.
Lze použít aproximace a počítat jen s $k$ nejpravděpodobnějšími hodnotami~\cite{thomson2010bayesian}.

Alternativním zjednodušením je rozdělit stav prostředí do skupin. 
Tento přístup se nazývá Hidden Information State (HIS)~\cite{young2010hidden}.
Základním předpokladem zde musí být, že uživatel nezmění svůj cíl v průběhu dialogu.
Pak lze efektivně provádět aktualizaci, protože rovnice pro aktualizace pravděpodobnosti se nemění mezi jednotlivými skupinami.

V této práci se budeme zabývat prvním přístupem, tedy použitím Bayesovských sítích.
Pro inferenci použijeme Loopy Belief Propagation (LBP) algoritmus, který je aproximativní metodou pro sítě s diskrétními náhodnými proměnnými.
Pro učení parametrů představíme Expectation Propagation (EP) algoritmus.
EP je zobecněním LBP na libovolné pravděpodobnostní rozložení.
